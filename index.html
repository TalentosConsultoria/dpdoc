<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Talentos Consultoria</title>
  <script data-cfasync="false" src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase compat (mantido) -->
  <script data-cfasync="false" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script data-cfasync="false" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <!-- Seus arquivos já existentes -->
  <script data-cfasync="false" src="./config.js"></script>
  <script data-cfasync="false" src="./auth-guard.js"></script>
  <style>
    body { background:#0b1020; color:#e5e7eb; }
    .card{ background:rgba(16,25,50,.92); border:1px solid rgba(255,255,255,.08); border-radius:20px; padding:24px; }
    .btn{ display:inline-block; padding:10px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.04); color:inherit; cursor:pointer; }
    .btn:hover{ border-color:#3b82f6; }
    .muted{ color:#9aa0aa; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="card w-full max-w-xl">
    <h1 class="text-3xl font-semibold mb-2">Acesso Talentos Consultoria</h1>
    <p class="muted mb-4">Faça login com sua conta corporativa @talentosconsultoria.com.br</p>
    <button id="btnLogin" class="btn">Entrar com Microsoft</button>
    <p id="status" class="muted mt-3"></p>
  </div>

  <script data-cfasync="false">
  (function(){
    const cfg = window.TalentosConfig || {};
    const statusEl = document.getElementById("status");
    const setStatus = (t)=>{ if(statusEl) statusEl.textContent = t || ""; };

    // URL de retorno
    const rawReturn = new URLSearchParams(location.search).get("return");
    const safeReturn = (window.TalentosAuthGuard && TalentosAuthGuard.safeReturnUrl)
      ? TalentosAuthGuard.safeReturnUrl(rawReturn || cfg.DEFAULT_RETURN || "index.html")
      : (rawReturn || "index.html");

    // Firebase
    if (!firebase?.auth) { setStatus("Firebase Auth não carregou."); return; }
    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    // Provider Microsoft
    const provider = new firebase.auth.OAuthProvider("microsoft.com");
    try {
      if (cfg.AAD_TENANT_ID) provider.setCustomParameters({ tenant: cfg.AAD_TENANT_ID });
      provider.setCustomParameters({ prompt: "select_account" });
    } catch(_) {}

    function emailDomainAllowed(email){
      if (window.TalentosAuthGuard?.emailDomainAllowed) return TalentosAuthGuard.emailDomainAllowed(email);
      const dom = (cfg.ALLOWED_EMAIL_DOMAIN || "talentosconsultoria.com.br").toLowerCase();
      return typeof email === "string" && email.toLowerCase().endsWith("@"+dom);
    }

    // Pós-redirect: processa se houver resultado pendente
    auth.getRedirectResult().then(res => {
      if (res && res.user) {
        const em = res.user.email || "";
        if (!emailDomainAllowed(em)) {
          setStatus("Domínio não autorizado: " + em);
          return auth.signOut();
        }
        return location.replace(safeReturn);
      }
    }).catch(err => {
      console.error("getRedirectResult:", err);
      // Não bloqueia a página; usuário pode tentar de novo no botão
    });

    // Sessão ativa -> vai para o index
    auth.onAuthStateChanged(user => {
      if (user && emailDomainAllowed(user.email || "")) {
        location.replace(safeReturn);
      }
    });

    // Clique do botão: tenta popup, cai para redirect se necessário
    document.getElementById("btnLogin")?.addEventListener("click", async ()=>{
      setStatus("Abrindo autenticador...");
      try {
        const res = await auth.signInWithPopup(provider);
        const em = res.user?.email || "";
        if (!emailDomainAllowed(em)) {
          setStatus("Domínio não autorizado: " + em);
          await auth.signOut();
          return;
        }
        location.replace(safeReturn);
      } catch (e) {
        if (e && (e.code === "auth/popup-blocked" || e.code === "auth/popup-closed-by-user")) {
          try {
            await auth.signInWithRedirect(provider);
            setStatus("Redirecionando para Microsoft...");
          } catch (e2) {
            console.error(e2);
            setStatus("Falha no redirect: " + (e2.message || e2));
          }
        } else {
          console.error(e);
          setStatus((e && e.message) ? e.message : "Falha ao iniciar login.");
        }
      }
    });
  })();
  </script>
</body>
</html>
