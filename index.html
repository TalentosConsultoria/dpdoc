<script data-cfasync="false">
(function(){
  const cfg = window.TalentosConfig || {};
  const statusEl = document.getElementById("status");
  const setStatus = (t)=>{ if(statusEl) statusEl.textContent = t || ""; };

  // URL de retorno segura
  const rawReturn = new URLSearchParams(location.search).get("return");
  const defaultReturn = cfg.DEFAULT_RETURN || "index.html";
  const safeReturn = (window.TalentosAuthGuard && TalentosAuthGuard.safeReturnUrl)
    ? TalentosAuthGuard.safeReturnUrl(rawReturn || defaultReturn)
    : (rawReturn || defaultReturn);

  // Firebase Auth (compat)
  if (!firebase?.auth) { setStatus("Firebase Auth não carregou."); return; }
  const auth = firebase.auth();
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

  // Microsoft provider com TENANT fixo (evita /common)
  const tenant = cfg.AAD_TENANT_ID || "cba0be9f-94ad-4a26-b291-fa90af7491ee";
  const provider = new firebase.auth.OAuthProvider("microsoft.com");
  try {
    provider.setCustomParameters({ tenant, prompt: "select_account" });
  } catch(_) {}

  function emailDomainAllowed(email){
    if (window.TalentosAuthGuard?.emailDomainAllowed) return TalentosAuthGuard.emailDomainAllowed(email);
    const dom = (cfg.ALLOWED_EMAIL_DOMAIN || "talentosconsultoria.com.br").toLowerCase();
    return typeof email === "string" && email.toLowerCase().endsWith("@"+dom);
  }

  function handleUser(user){
    const em = user?.email || "";
    if (!emailDomainAllowed(em)) {
      setStatus("Domínio não autorizado: " + em);
      return auth.signOut();
    }
    location.replace(safeReturn);
  }

  // 1) Processa retorno do redirect (se houver)
  auth.getRedirectResult()
    .then(res => { if (res && res.user) handleUser(res.user); })
    .catch(err => {
      console.error("getRedirectResult:", err);
      const msg = (err && err.message) || "";
      if (msg.includes("AADSTS50194")) setStatus("Falha de tenant (/common). Tente novamente.");
    });

  // 2) Se já logado, segue
  auth.onAuthStateChanged(u => { if (u) handleUser(u); });

  // 3) Clique → popup; se bloquear, fallback para redirect
  document.getElementById("btnLogin")?.addEventListener("click", async ()=>{
    setStatus("Abrindo autenticador…");
    try {
      const res = await auth.signInWithPopup(provider);
      if (res?.user) handleUser(res.user);
    } catch (e) {
      try {
        await auth.signInWithRedirect(provider);
        setStatus("Redirecionando para Microsoft…");
      } catch (e2) {
        console.error("signInWithRedirect:", e2);
        setStatus((e2 && (e2.code + " – " + e2.message)) || "Falha ao iniciar login.");
      }
    }
  });
})();
</script>
