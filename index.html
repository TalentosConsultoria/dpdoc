<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, getRedirectResult,
    OAuthProvider, signInWithRedirect
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAL8t7tsgoCoNj3nkfUG3mKz0WEpRmH3K8",
    authDomain: "talentosbd-e4206.firebaseapp.com",
    projectId: "talentosbd-e4206",
    storageBucket: "talentosbd-e4206.appspot.com",
    messagingSenderId: "580727253031",
    appId: "1:580727253031:web:5363082ef0da6277788602",
    measurementId: "G-S464LNX2J9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const params = new URLSearchParams(location.search);
  let returnUrl = params.get("return") || "index.html";

  const btn = document.getElementById("btn-ms");
  const setBusy = (b)=>{ if(btn){ b?btn.setAttribute("disabled",""):btn.removeAttribute("disabled"); } };

  const provider = new OAuthProvider("microsoft.com");
  provider.setCustomParameters({ domain_hint: "talentosconsultoria.com.br", prompt: "select_account" });

  async function doRedirectLogin(){
    sessionStorage.setItem("msLoginInProgress","1");
    setBusy(true);
    await signInWithRedirect(auth, provider);
  }

  if (btn) btn.addEventListener("click", (e)=>{ e.preventDefault(); doRedirectLogin(); });

  try {
    setBusy(true);
    const res = await getRedirectResult(auth);
    if (res?.user) {
      sessionStorage.removeItem("msLoginInProgress");
      location.replace(returnUrl);
    } else {
      onAuthStateChanged(auth, (user)=>{
        if (user) {
          sessionStorage.removeItem("msLoginInProgress");
          location.replace(returnUrl);
        } else {
          const inProgress = sessionStorage.getItem("msLoginInProgress")==="1";
          if (!inProgress) doRedirectLogin(); else setBusy(false);
        }
      });
    }
  } catch (e) {
    console.error(e);
    sessionStorage.removeItem("msLoginInProgress");
    setBusy(false);
  }
</script>
