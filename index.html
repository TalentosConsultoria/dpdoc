<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, getRedirectResult,
    OAuthProvider, signInWithRedirect
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // --- Firebase config (chave certa!) ---
  const firebaseConfig = {
    apiKey: "AIzaSyAL8t7tsgoCoNj3nkfUG3mKz0WEpRmH3K8",
    authDomain: "talentosbd-e4206.firebaseapp.com",
    projectId: "talentosbd-e4206",
    storageBucket: "talentosbd-e4206.appspot.com",
    messagingSenderId: "580727253031",
    appId: "1:580727253031:web:5363082ef0da6277788602",
    measurementId: "G-S464LNX2J9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const provider = new OAuthProvider("microsoft.com");
  provider.setCustomParameters({
    domain_hint: "talentosconsultoria.com.br",
    prompt: "select_account"
  });

  const params = new URLSearchParams(location.search);
  const returnUrl = params.get("return") || "index.html";

  async function doRedirectLogin(){
    sessionStorage.setItem("msLoginInProgress","1");
    const btn = document.getElementById("btn-ms");
    if (btn) btn.setAttribute("disabled","");
    await signInWithRedirect(auth, provider);
  }

  // Garante que o DOM existe antes de buscar o botão
  window.addEventListener("DOMContentLoaded", async () => {
    const btn = document.getElementById("btn-ms");
    if (btn) {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        doRedirectLogin();
      });
    }

    try {
      const res = await getRedirectResult(auth);
      if (res?.user) {
        sessionStorage.removeItem("msLoginInProgress");
        location.replace(returnUrl);
        return;
      }
    } catch (e) {
      console.error(e);
      sessionStorage.removeItem("msLoginInProgress");
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        sessionStorage.removeItem("msLoginInProgress");
        location.replace(returnUrl);
      } else {
        // Se quiser login automático sem botão:
        // doRedirectLogin();
        // Caso prefira usar botão, deixe só ele visível e não force o redirect aqui.
      }
    });
  });
</script>
