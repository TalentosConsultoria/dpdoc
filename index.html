<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Acesso Talentos</title>
  <style>
    body{margin:0;background:#eef3ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .card{max-width:560px;margin:18vh auto;background:#fff;padding:36px 28px;border-radius:16px;box-shadow:0 25px 60px rgba(0,40,140,.15)}
    h1{font-size:28px;color:#1f3bb3;margin:0 0 12px}
    p{margin:0 0 18px;color:#334}
    .btn{display:inline-block;background:#2563eb;color:#fff;border:0;border-radius:10px;padding:12px 18px;font-weight:600;cursor:pointer}
    .muted{color:#667}
  </style>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithRedirect,
      getRedirectResult,
      OAuthProvider
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    // ---- CONFIG FIREBASE (a mesma do seu projeto) ----
    const firebaseConfig = {
      apiKey: "AIzaSyAL8t7sgoCoNj3nkfUG3mkz0WEpRmH3K8",
      authDomain: "talentosbd-e4206.firebaseapp.com",
      projectId: "talentosbd-e4206",
      appId: "1:xxxxxxxxxxxx:web:xxxxxxxxxxxxxx" // opcional
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ---- LÊ o destino de retorno (ex.: ?return=index.html) ----
    const url = new URL(window.location.href);
    const returnTo = url.searchParams.get("return") || "index.html";
    sessionStorage.setItem("returnAfterLogin", returnTo);

    // ---- Provider Microsoft travado no seu tenant ----
    const provider = new OAuthProvider('microsoft.com');
    provider.setCustomParameters({
      // Tenant do seu print: cba0be9f-94ad-4a26-b291-fa90af7491ee
      tenant: "cba0be9f-94ad-4a26-b291-fa90af7491ee"
    });

    // ---- GUARDAS CONTRA LOOP ----
    // 1) Só dispara redirect se ainda não começou
    async function ensureSignIn() {
      try {
        // Se acabamos de voltar do Microsoft, o Firebase resolve aqui
        await getRedirectResult(auth);
      } catch(e) {
        console.warn("getRedirectResult:", e);
      }

      const user = auth.currentUser;
      if (user) {
        // Já autenticado -> segue para o destino
        const dest = sessionStorage.getItem("returnAfterLogin") || "index.html";
        // segurança básica: não deixa sair do mesmo domínio
        if (!/^[a-z0-9_\-./]+$/i.test(dest)) {
          window.location.href = "index.html";
        } else {
          window.location.href = dest;
        }
        return;
      }

      // Se não tem user E ainda não iniciamos o redirect nesta aba, inicia
      if (!sessionStorage.getItem("redirectStarted")) {
        sessionStorage.setItem("redirectStarted", "1");
        signInWithRedirect(auth, provider);
      }
      // Se já iniciou, aguardamos voltar do handler (a página mostra o botão como fallback)
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const dest = sessionStorage.getItem("returnAfterLogin") || "index.html";
        if (!/^[a-z0-9_\-./]+$/i.test(dest)) {
          window.location.href = "index.html";
        } else {
          window.location.href = dest;
        }
      }
    });

    // dispara o fluxo quando a página carrega
    window.addEventListener("load", ensureSignIn);

    // Botão de fallback manual
    window.startLogin = () => {
      sessionStorage.setItem("redirectStarted", "1");
      signInWithRedirect(auth, provider);
    };
  </script>
</head>
<body>
  <div class="card">
    <h1>Acesso Talentos</h1>
    <p>Redirecionando para login corporativo…</p>
    <p class="muted">Se não redirecionar automaticamente, clique no botão abaixo.</p>
    <br />
    <button class="btn" onclick="startLogin()">Entrar com Microsoft</button>
  </div>
</body>
</html>
