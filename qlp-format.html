<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatador de QLP - Talentos Consultoria</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#004aad',
                        secondary: '#196dff',
                        background: '#f1f5f9',
                        card: '#ffffff',
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Firebase compat 10.12.4 (app, auth e firestore) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

    <!-- Script de configuração e autenticação -->
    <script>
      // ======== CONFIG APP (copiado do config.js) ========
      const firebaseConfig = {
        apiKey: "AIzaSyAL8t7tsgoCoNj3nkfUG3mKz0WEpRmH3K8",
        authDomain: "talentosbd-e4206.firebaseapp.com",
        projectId: "talentosbd-e4206",
        storageBucket: "talentosbd-e4206.firebasestorage.app",
        messagingSenderId: "580727253031",
        appId: "1:580727253031:web:5368302ef0da6277788602",
        measurementId: "G-S464LNX2J9"
      };

      // ======== AUTH GUARD ========
      window.onload = () => {
        try {
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          const auth = firebase.auth();
          auth.onAuthStateChanged(user => {
            if (!user) {
              window.location.replace(window.location.origin + "/login.html");
            }
          });
        } catch (e) {
          console.error("Auth guard init error:", e);
        }
      };
    </script>
</head>

<body class="bg-background flex flex-col min-h-screen font-sans">

    <header class="bg-white shadow-md p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <img src="https://media.glassdoor.com/sqll/2733569/talentos-consultoria-squarelogo-1649741391944.png" alt="Logo da Talentos Consultoria" class="h-10 rounded-full shadow-md">
                <span class="text-xl font-bold text-red-700 hidden md:block">Talentos Consultoria</span>
            </a>
            <nav class="relative">
                <button id="tools-dropdown-button" class="text-gray-600 hover:text-primary font-semibold transition duration-300 flex items-center space-x-1 focus:outline-none">
                    <span>Ferramentas</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div id="tools-dropdown-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden">
                    <a href="qlp-format.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">QLP</a>
                    <a href="pdf-tool.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">PDF</a>
                    <a href="format-bancodoc.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Bdoc</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex-grow flex justify-center items-center p-4">
        <div class="bg-card p-8 md:p-12 rounded-3xl shadow-2xl w-full max-w-lg text-center">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Importar e Formatar Planilha QLP</h1>
            <p class="text-gray-600 mb-6">Preencha o nome da unidade (opcional) e importe a planilha. As colunas serão selecionadas para formatação antes do download.</p>
            
            <div class="mb-6 text-left">
                <label for="unit-name-input" class="block mb-2 text-sm font-medium text-gray-700">Nome da Unidade (Opcional):</label>
                <input type="text" id="unit-name-input" placeholder="Ex: AMBEV NOVA RIO" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
            </div>
            
            <label for="file-input" class="block w-full text-center p-4 cursor-pointer bg-primary text-white rounded-lg font-semibold hover:bg-secondary transition-colors duration-300">
                Importar Planilha
            </label>
            <input id="file-input" type="file" accept=".csv, .xlsx, .xls" class="hidden"/>
        </div>
    </main>

    <div id="column-selection-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md relative mx-4">
            <button id="close-modal-button" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold cursor-pointer">&times;</button>
            <h3 class="text-xl font-semibold mb-4 pb-4 border-b">Selecione as colunas a manter:</h3>
            <ul id="column-list" class="list-none p-0 max-h-60 overflow-y-auto space-y-3">
                </ul>
            <button onclick="downloadSelectedColumns()" class="w-full mt-6 p-3 bg-primary text-white rounded-lg font-semibold hover:bg-secondary transition-colors">
                Baixar Planilha Formatada
            </button>
        </div>
    </div>
    
    <footer class="bg-gray-800 text-white text-center p-4">
        <p>&copy; 2025 Talentos Consultoria. Todos os direitos reservados.</p>
    </footer>

    <script>
        // Script para o dropdown do cabeçalho
        const dropdownButton = document.getElementById('tools-dropdown-button');
        const dropdownMenu = document.getElementById('tools-dropdown-menu');
        if (dropdownButton && dropdownMenu) {
            dropdownButton.addEventListener('click', (event) => {
                event.stopPropagation();
                dropdownMenu.classList.toggle('hidden');
            });
            window.addEventListener('click', () => {
                if (!dropdownMenu.classList.contains('hidden')) {
                    dropdownMenu.classList.add('hidden');
                }
            });
        }

        // Funcionalidade da ferramenta QLP
        let rawData;
        const fileInput = document.getElementById('file-input');
        const modal = document.getElementById('column-selection-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        
        const headerMapping = [
            { newName: "CADASTRO", originalIndex: 0 },
            { newName: "NOME", originalIndex: 1 },
            { newName: "SITUACAO", originalIndex: 4 },
            { newName: "FILIAL", originalIndex: 5 },
            { newName: "VINCULO", originalIndex: 6 },
            { newName: "ADMISSAO", originalIndex: 7 },
            { newName: "CARGO", originalIndex: 8 },
            { newName: "NASCIMENTO", originalIndex: 10 },
            { newName: "CTPS", originalIndex: 11 },
            { newName: "SERIE", originalIndex: 13 },
            { newName: "RG", originalIndex: 14 },
            { newName: "CPF", originalIndex: 15 },
            { newName: "PIS", originalIndex: 16 }
        ];

        fileInput.addEventListener('change', handleFile, false);
        closeModalButton.addEventListener('click', () => modal.classList.add('hidden'));
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                modal.classList.add('hidden');
            }
        });

        function excelDateToJSDate(serial) {
            const utc_days  = Math.floor(serial - 25569);
            const utc_value = utc_days * 86400;
            const date_info = new Date(utc_value * 1000);
            const day = String(date_info.getDate()).padStart(2, '0');
            const month = String(date_info.getMonth() + 1).padStart(2, '0');
            const year = date_info.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function handleFile(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            const file = files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                displayColumnSelectionModal();
            };

            reader.readAsArrayBuffer(file);
        }

        function displayColumnSelectionModal() {
            const columnList = document.getElementById('column-list');
            columnList.innerHTML = '';

            headerMapping.forEach(mapping => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <label class="flex items-center text-gray-700 cursor-pointer">
                        <input type="checkbox" checked value="${mapping.originalIndex}" class="mr-3 h-5 w-5 rounded text-primary focus:ring-primary border-gray-300">
                        ${mapping.newName}
                    </label>
                `;
                columnList.appendChild(li);
            });

            modal.classList.remove('hidden');
        }

        function downloadSelectedColumns() {
            const unitName = document.getElementById('unit-name-input').value.trim();
            // A verificação de obrigatoriedade foi removida daqui.

            const checkedBoxes = document.querySelectorAll('#column-list input[type="checkbox"]:checked');
            const columnsToKeep = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

            const newHeaders = Array.from(checkedBoxes).map(cb => {
                const originalIndex = parseInt(cb.value);
                const mapping = headerMapping.find(m => m.originalIndex === originalIndex);
                return mapping ? mapping.newName : "COLUNA DESCONHECIDA";
            });
            
            processAndDownloadData(rawData, columnsToKeep, newHeaders, unitName);

            modal.classList.add('hidden');
        }

        function processAndDownloadData(data, columnsToKeep, newHeaders, unitName) {
            if (data.length <= 4) {
                alert("O arquivo não tem linhas suficientes para serem processadas.");
                return;
            }
            const dataWithoutFirstFourRows = data.slice(4);

            let finalDataRows = [];
            let rowsKept = 0;
            let rowsSkipped = 0;

            for (let i = 0; i < dataWithoutFirstFourRows.length; i++) {
                if (rowsKept < 46) {
                    finalDataRows.push(dataWithoutFirstFourRows[i]);
                    rowsKept++;
                } else if (rowsSkipped < 5) {
                    rowsSkipped++;
                }

                if (rowsSkipped === 5) {
                    rowsKept = 0;
                    rowsSkipped = 0;
                }
            }

            const firstColumnIndex = 0;
            const totalRowIndex = finalDataRows.findIndex(row =>
                row[firstColumnIndex] && String(row[firstColumnIndex]).toLowerCase().includes("total")
            );

            if (totalRowIndex !== -1) {
                finalDataRows = finalDataRows.slice(0, totalRowIndex);
            }
            
            const findOriginalIndex = (name) => {
                const mapping = headerMapping.find(m => m.newName === name);
                return mapping ? mapping.originalIndex : -1;
            };

            const vinculoOriginalIndex = findOriginalIndex("VINCULO");
            const situacaoOriginalIndex = findOriginalIndex("SITUACAO");
            const filialOriginalIndex = findOriginalIndex("FILIAL");
            const cpfOriginalIndex = findOriginalIndex("CPF");
            const pisOriginalIndex = findOriginalIndex("PIS");
            const admissaoOriginalIndex = findOriginalIndex("ADMISSAO");
            const nascimentoOriginalIndex = findOriginalIndex("NASCIMENTO");

            const formattedData = finalDataRows.map(row => {
                const newRow = [];

                columnsToKeep.forEach(columnIndex => {
                    let cellData = row[columnIndex] || '';

                    if (columnIndex === vinculoOriginalIndex) {
                        const vinculoMap = { "10": "EFETIVO/CLT", "50": "TEMPORARIO", "55": "JOVEM APRENDIZ" };
                        cellData = vinculoMap[String(cellData)] || cellData;
                    }

                    if (columnIndex === situacaoOriginalIndex) {
                        const situacaoMap = { "1": "Trabalhando", "2": "Férias", "3": "Auxílio Doença", "4": "Acidente de Trabalho", "5": "Serviço Militar", "6": "Licença Maternidade", "7": "Demitido" };
                        const key = String(parseInt(cellData)); // Normaliza "001" para "1"
                        cellData = situacaoMap[key] || cellData;
                    }
                    
                    if (columnIndex === filialOriginalIndex) {
                        const filialMap = {1:"TALENTOS - CLT",2:"TALENTOS - TEMPORARIO",3:"AMBEV CACHOEIRAS DE MACACU - CLT",4:"AMBEV CACHOEIRAS DE MACACU - TEMPORARIO",5:"AMBEV NOVA RIO - CLT",6:"AMBEV NOVA RIO - TEMPORARIO",7:"ARM ARMAZENS - CLT",8:"ARM ARMAZENS - TEMPORARIO",9:"BUNGE ALIMENTOS - CLT",10:"BUNGE ALIMENTOS - TEMPORARIO",11:"CARTA GOIAS - CLT",12:"CARTA GOIAS - TEMPORARIO",13:"GUANABARA T DE CASTRO - CLT",14:"GUANABARA T DE CASTRO - TEMPORARIO",15:"GUANABARA AGUA BRANCA - CLT",16:"GUANABARA AGUA BRANCA - TEMPORARIO",17:"CERVEJARIA BOHEMIA - CLT",18:"CERVEJARIA BOHEMIA - TEMPORARIO",19:"CLUB MED - CLT",20:"CLUB MED - TEMPORARIO",21:"CEPE/RIO - CLT",22:"CEPE/RIO - TEMPORARIO",23:"CORRFA - CLT",24:"CORRFA - TEMPORARIO",25:"CONSORCIO PIPE - CLT",26:"CONSORCIO PIPE - TEMPORARIO",27:"HALLIDAY GUIMARAES - CLT",28:"HALLIDAY GUIMARAES - TEMPORARIO",29:"CONTRUTORA NORBERTO ODEBRECHT - CLT",30:"CONTRUTORA NORBERTO ODEBRECHT - TEMPORARIO",31:"CRBS CDD JPA - CLT",32:"CRBS CDD JPA - TEMPORARIO",33:"CRBS CDD PAVUNA - CLT",34:"CRBS CDD PAVUNA - TEMPORARIO",35:"CRBS CDD SC - CLT",36:"CRBS CDD SC - TEMPORARIO",37:"CERVEJARIA JAGUARIUNA - CLT",38:"CERVEJARIA JAGUARIUNA - TEMPORARIO",39:"CERVEJARIA AGUAS CLARAS - CLT",40:"CERVEJARIA AGUAS CLARAS - TEMPORARIO",41:"CERVEJARIA LEYENDA - CLT",42:"CERVEJARIA LEYENDA - TEMPORARIO",43:"CERVEJARIA SAO LUIS - CLT",44:"CERVEJARIA SAO LUIS - TEMPORARIO",45:"CERVEJARIA SAO LUIS FABRICA - CLT",46:"CERVEJARIA SAO LUIS FABRICA - TEMPORARIO",47:"CONSTRUTORA QUEIROZ GALVAO - CLT",48:"CONSTRUTORA QUEIROZ GALVAO - TEMPORARIO",49:"CONSTRUTORA QUEIROZ GALVAO - GO",50:"CONSTRUTORA QUEIROZ GALVAO - GO",51:"CONSTRUTORA QUEIROZ GALVAO - SP",52:"VIGODENT INDUSTRIA - CLT",53:"VIGODENT INDUSTRIA - TEMPORARIO",54:"VIATRIS DISTRIBUIDORA - CLT",55:"VIATRIS DISTRIBUIDORA - TEMPORARIO",56:"CONSORCIO PIPE - CLT",57:"CONSORCIO PIPE - TEMPORARIO",58:"BRF - CLT",59:"VIATRIS CAMPOS",60:"VIATRIS CAMPOS - TEMPORARIO",61:"MYLAN/VIATRIS CAMPINAS - CLT",62:"MYLAN/VIATRIS CAMPINAS - TEMPORARIO",63:"PROJETO VILA LEOPOLDINA - CLT",64:"PROJETO VILA LEOPOLDINA - TEMPORARIO",65:"PROJETO VOLTA REDONDA - CLT",66:"PROJETO VOLTA REDONDA - TEMPORARIO",67:"PROJETO MINAS GERAIS - CLT",68:"PROJETO MINAS GERAIS - TEMPORARIO",69:"CRBS CDD VOLTA REDONDA - CLT",70:"CRBS CDD VOLTA REDONDA - TEMPORARIO",71:"CRBS CDD NOVA IGUAÇU - CLT",72:"CRBS CDD NOVA IGUAÇU - TEMPORARIO",73:"CRBS CDD VOLTA REDONDA - CLT",74:"CRBS CDD VOLTA REDONDA - TEMPORARIO",75:"ALYA - CLT",76:"ALYA - TEMPORARIO",77:"PROJETO JPA ARQUIVO CLT",78:"PROJETO JPA ARQUIVO TEMP",79:"EXTERRAN - CLT",80:"EXTERRAN - TEMPORARIO",81:"MYLAN DISTRIBUIDORA DE MEDICAMENTOS - CLT",82:"MYLAN DISTRIBUIDora DE MEDICAMENTOS - TEMPORARIO",83:"AMBEV JAGUARIUNA - CLT",84:"AMBEV JAGUARIUNA - TEMPORARIO",85:"BELA VISTA INCORPORADORA - CLT",86:"BELA VISTA INCORPORADORA - TEMPORARIO",87:"KONGSBERG MARITIME CM BRASIL LTDA. - CLT",88:"KONGSBERG MARITIME CM BRASIL LTDA - TEMPORARIO",89:"CNO S/A - CLT",90:"CNO S/A - TEMPORARIO",91:"BLU (ENOPP) - CLT",92:"BLU (ENOPP) - TEMPORARIO",93:"MYLAN BRASIL DISTRIBUIDORA - CLT",94:"MYLAN BRASIL DISTRIBUIDORA - TEMPORARIO",95:"BALL EMBALAGENS LTDA - CLT",96:"BALL EMBALAGENS LTDA - TEMPORARIOS",97:"LATICINIOS BELA VISTA - CLT",98:"LATICINIOS BELA VISTA - TEMPORARIO",99:"TALENTOS RJ - CLT",100:"TALENTOS RJ - TEMPORARIO",101:"TALENTOS SP - CLT",102:"AMBEV PIRAI - CLT",103:"AMBEV PIRAI - TEMPORARIO",104:"AMBEV VIDROS - CLT",105:"AMBEV VIDROS - TEMPORARIO",106:"KONGSBERG MARITIME - CLT",107:"KONGSBERG MARITIME - TEMPORARIO",108:"SVITZER - CLT",109:"SVITZER - TEMPORARIO",110:"VIATRIS BRASIL - CLT",111:"VIATRIS BRASIL - TEMPORARIO",112:"GREIF - CLT",113:"VIATRIS SP - CLT",114:"ABS - CLT",115:"ABS - TEMPORARIO",116:"RUHRPUMPEN - CLT",117:"RUHRPUMPEN - TEMPORARIO",118:"AMBEV NOVA RIO EMP - CLT",119:"AMBEV NOVA RIO EMP - TEMPORARIO",};
                        cellData = filialMap[cellData] || cellData;
                    }

                    if (columnIndex === cpfOriginalIndex) {
                        let cpf = String(cellData).replace(/\D/g, '').padStart(11, '0');
                        if (cpf.length === 11) cellData = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                    }

                    if (columnIndex === pisOriginalIndex) {
                        let pis = String(cellData).replace(/\D/g, '').padStart(11, '0');
                        if (pis.length === 11) cellData = pis.replace(/(\d{3})(\d{5})(\d{2})(\d{1})/, '$1.$2.$3-$4');
                    }

                    if ((columnIndex === admissaoOriginalIndex || columnIndex === nascimentoOriginalIndex) && typeof cellData === 'number') {
                        cellData = excelDateToJSDate(cellData);
                    }

                    newRow.push(cellData);
                });
                return newRow;
            });

            formattedData.unshift(newHeaders);

            const newWorkbook = XLSX.utils.book_new();
            const newWorksheet = XLSX.utils.aoa_to_sheet(formattedData);
            
            XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "Planilha Formatada");
            
            // Define um nome de arquivo padrão caso o nome da unidade esteja vazio
            const fileName = `QLP - ${unitName || 'PlanilhaFormatada'}.xlsx`;
            XLSX.writeFile(newWorkbook, fileName);

            fileInput.value = null;
        }
    </script>
</body>
</html>
