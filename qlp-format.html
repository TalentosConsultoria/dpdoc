<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formatador de Planilhas com Seleção</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; color: #333; text-align: center; }
    .container { max-width: 500px; margin: 100px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
    input[type="file"] { display: none; }
    .custom-file-upload { border: 1px solid #ccc; display: inline-block; padding: 10px 20px; cursor: pointer; background: #28a745; color: #fff; border-radius: 5px; font-size: 16px; transition: background-color .3s; }
    .custom-file-upload:hover { background: #218838; }
    .modal { display: none; position: fixed; z-index: 1; inset: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,.4); padding-top: 60px; }
    .modal-content { background: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; text-align: left; }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-button:hover, .close-button:focus { color: #000; text-decoration: none; }
    .column-list { list-style: none; padding: 0; }
    .column-list li { margin: 10px 0; }
    .button-download { display: block; width: 100%; padding: 10px; background: #007BFF; color: #fff; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    .button-download:hover { background: #0056b3; }

    /* Estilos para a seção de busca e filtros */
    .search-container { margin: 40px auto -60px; text-align: left; }
    #search-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
    #operations-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; background: #fff; }
    #operations-list li { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 14px; }
    #operations-list li:last-child { border-bottom: none; }
    #operations-list li .code { font-weight: bold; color: #0056b3; margin-right: 15px; background-color: #e7f3ff; padding: 3px 8px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; font-size: 12px; }
    
    #filter-container h4 { margin-top: 20px; margin-bottom: 10px; border-top: 1px solid #eee; padding-top: 20px; }
    #filter-list-container { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #fafafa; }
  </style>
</head>
<body>

  <div class="container">
    <h2>Importar e Baixar Planilha Formatada</h2>
    <p>Clique abaixo para importar sua planilha. Você será solicitado a selecionar as colunas e filtros desejados antes do download.</p>
    <label for="file-input" class="custom-file-upload">Importar Planilha</label>
    <input id="file-input" type="file" accept=".csv, .xlsx, .xls" />
  </div>

  <div id="column-selection-modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>1. Selecione as colunas que deseja manter:</h3>
      <ul id="column-list" class="column-list"></ul>
      
      <!-- Container para os filtros de operação -->
      <div id="filter-container"></div>

      <button class="button-download" onclick="downloadSelectedColumns()">Filtrar e Baixar Planilha</button>
    </div>
  </div>

  <div class="container search-container">
    <h2>Busca de Operações</h2>
    <p>Digite o nome ou código de uma operação para encontrá-la na lista.</p>
    <input type="text" id="search-input" placeholder="Buscar operação...">
    <ul id="operations-list"></ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    let rawData;
    let isDate1904 = false;

    const headerMapping = [
      { newName: "CADASTRO",   originalIndex: 0 }, { newName: "NOME",       originalIndex: 1 },
      { newName: "SITUACAO",   originalIndex: 4 }, { newName: "FILIAL",     originalIndex: 5 },
      { newName: "VINCULO",    originalIndex: 6 }, { newName: "ADMISSAO",   originalIndex: 7 },
      { newName: "CARGO",      originalIndex: 8 }, { newName: "NASCIMENTO", originalIndex: 10 },
      { newName: "CTPS",       originalIndex: 11 }, { newName: "SERIE",      originalIndex: 13 },
      { newName: "RG",         originalIndex: 14 }, { newName: "CPF",        originalIndex: 15 },
      { newName: "PIS",        originalIndex: 16 }
    ];

    const filialMapping = [
      { code: '3', name: 'AMBEV - MACACU' }, { code: '4', name: 'AMBEV - MACACU TEMPORÁRIO' },
      { code: '5', name: 'AMBEV - NOVA RIO' }, { code: '6', name: 'AMBEV - NOVA RIO TEMPORÁRIO' },
      { code: '9', name: 'BUNGE' }, { code: '17', name: 'ZX - BOHEMIA' }, { code: '18', name: 'ZX - BOHEMIA TEMPORÁRIO' },
      { code: '22', name: 'CEPE' }, { code: '31', name: 'CRBS - JPA' }, { code: '32', name: 'CRBS - JPA TEMPORÁRIO' },
      { code: '33', name: 'CRBS - PAVUNA' }, { code: '34', name: 'CRBS - PAVUNA TEMPORÁRIO' }, { code: '35', name: 'CRBS - SC' },
      { code: '36', name: 'CRBS - SC TEMPORÁRIO' }, { code: '52', name: 'VIGODENT INDUSTRIA' }, { code: '59', name: 'VIATRIS CAMPOS' },
      { code: '60', name: 'VIATRIS CAMPOS - TEMPORÁRIO' }, { code: '71', name: 'CRBS - NOVA IGUAÇU' },
      { code: '72', name: 'CRBS - NOVA IGUAÇU TEMPORARIO' }, { code: '74', name: 'VOLTA REDONDA' }, { code: '89', name: 'CNO' },
      { code: '90', name: 'CNO - TEMPORARIO' }, { code: '93', name: 'MYLAN' }, { code: '94', name: 'MYLAN - TEMPORARIO' },
      { code: '95', name: 'BALL' }, { code: '96', name: 'BALL - TEMPORARIO' }, { code: '100', name: 'VIATRIS BRASIL - TEMPORARIO' },
      { code: '101', name: 'VIATRIS SP - TEMPORARIO' }, { code: '102', name: 'AMBEV - PIRAI' }, { code: '103', name: 'AMBEV - PIRAI TEMPORÁRIO' },
      { code: '104', name: 'AMBEV - VIDROS' }, { code: '105', name: 'AMBEV - VIDROS TEMPORÁRIO' }, { code: '106', name: 'KONGSBERG MARITIME' },
      { code: '107', name: 'KONGSBERG MARITIME- TEMPORARIO' }, { code: '108', name: 'SVITZER' }, { code: '109', name: 'SVITZER TEMPORARIO' },
      { code: '110', name: 'VIATRIS BRASIL' }, { code: '112', name: 'GREIF' }, { code: '113', name: 'VIATRIS SP' },
      { code: '114', name: 'ABS' }, { code: '115', name: 'ABS - TEMPORÁRIO' }, { code: '116', name: 'RUHRPUMPEN' },
      { code: '118', name: 'AMBEV - NOVA RIO EMP' }, { code: '119', name: 'AMBEV - NOVA RIO EMP TEMPORÁRIO' }
    ];

    const fileInput = document.getElementById('file-input');
    const modal = document.getElementById('column-selection-modal');
    const closeBtn = document.querySelector('.close-button');
    const searchInput = document.getElementById('search-input');
    const operationsList = document.getElementById('operations-list');

    const findOriginalIndex = (name) => (headerMapping.find(m => m.newName === name)?.originalIndex ?? -1);

    fileInput.addEventListener('change', handleFile, false);
    closeBtn.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    searchInput.addEventListener('input', (e) => populateOperationsList(e.target.value));

    function excelSerialToBRDate(serial) {
        if (serial == null || serial === '') return '';
        const n = isDate1904 ? (Number(serial) + 1462) : Number(serial);
        const dc = XLSX.SSF.parse_date_code(n);
        if (!dc) return '';
        const dd = String(dc.d).padStart(2, '0');
        const mm = String(dc.m).padStart(2, '0');
        const yy = dc.y;
        return `${dd}/${mm}/${yy}`;
    }

    function handleFile(e) {
        const files = e.target.files;
        if (!files.length) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const workbook = XLSX.read(data, { type: 'array', raw: true, cellDates: false });
            isDate1904 = !!(workbook?.Workbook?.WBProps?.date1904);
            const firstSheet = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheet];
            rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });
            displayColumnSelectionModal();
        };
        reader.readAsArrayBuffer(files[0]);
    }

    function displayColumnSelectionModal() {
        const ul = document.getElementById('column-list');
        ul.innerHTML = '';
        headerMapping.forEach(m => {
            const li = document.createElement('li');
            li.innerHTML = `<label><input type="checkbox" checked value="${m.originalIndex}"> ${m.newName}</label>`;
            ul.appendChild(li);
        });

        const filterContainer = document.getElementById('filter-container');
        filterContainer.innerHTML = ''; // Limpa filtros anteriores

        const filialIdx = findOriginalIndex('FILIAL');
        if (filialIdx !== -1 && rawData && rawData.length > 4) {
            const operationCodes = [...new Set(rawData.slice(4).map(row => String(row[filialIdx])).filter(Boolean))].sort((a, b) => a - b);

            if (operationCodes.length > 0) {
                const h4 = document.createElement('h4');
                h4.innerHTML = `2. Filtrar por Operação <small>(deixe tudo desmarcado para incluir todas)</small>`;
                filterContainer.appendChild(h4);

                const filterListContainer = document.createElement('div');
                filterListContainer.id = 'filter-list-container';
                
                const filterList = document.createElement('ul');
                filterList.className = 'column-list';

                operationCodes.forEach(code => {
                    const operation = filialMapping.find(f => f.code === code);
                    const name = operation ? `<b>${code}</b> - ${operation.name}` : `Código: <b>${code}</b>`;
                    const li = document.createElement('li');
                    li.innerHTML = `<label><input type="checkbox" class="operation-filter" value="${code}"> ${name}</label>`;
                    filterList.appendChild(li);
                });

                filterListContainer.appendChild(filterList);
                filterContainer.appendChild(filterListContainer); // CORREÇÃO APLICADA AQUI
            }
        }
        modal.style.display = 'block';
    }

    function downloadSelectedColumns() {
        const checks = document.querySelectorAll('#column-list input[type="checkbox"]:checked');
        const columnsToKeep = Array.from(checks).map(cb => parseInt(cb.value, 10));

        const newHeaders = Array.from(checks).map(cb => {
            const idx = parseInt(cb.value, 10);
            const m = headerMapping.find(h => h.originalIndex === idx);
            return m ? m.newName : 'COLUNA DESCONHECIDA';
        });

        const filterChecks = document.querySelectorAll('.operation-filter:checked');
        const selectedOperations = Array.from(filterChecks).map(cb => cb.value);

        processAndDownloadData(rawData, columnsToKeep, newHeaders, selectedOperations);
        modal.style.display = 'none';
    }

    function populateOperationsList(filter = '') {
        operationsList.innerHTML = '';
        const searchTerm = filter.trim().toLowerCase();
        const filtered = filialMapping.filter(op => op.name.toLowerCase().includes(searchTerm) || op.code.includes(searchTerm));
        if (filtered.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'Nenhuma operação encontrada.';
            operationsList.appendChild(li);
            return;
        }
        filtered.forEach(op => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="code">Cód: ${op.code}</span> ${op.name}`;
            operationsList.appendChild(li);
        });
    }

    function processAndDownloadData(data, columnsToKeep, newHeaders, selectedOperations) {
        if (data.length <= 4) {
            console.error('O arquivo não tem linhas suficientes para serem processadas.');
            return;
        }
        
        let dataRows = data.slice(4);

        // ETAPA 1: APLICA O FILTRO DE OPERAÇÃO SE ALGUMA FOI SELECIONADA
        if (selectedOperations && selectedOperations.length > 0) {
            const filialIdx = findOriginalIndex('FILIAL');
            if (filialIdx !== -1) {
                dataRows = dataRows.filter(row => selectedOperations.includes(String(row[filialIdx])));
            }
        }

        // ETAPA 2: APLICA A REGRA DE MANTER 46 E PULAR 5 LINHAS
        let finalRows = [], keep = 0, skip = 0;
        for (let i = 0; i < dataRows.length; i++) {
            if (keep < 46) { finalRows.push(dataRows[i]); keep++; }
            else if (skip < 5) { skip++; }
            if (skip === 5) { keep = 0; skip = 0; }
        }

        // ETAPA 3: REMOVE LINHAS A PARTIR DAQUELA QUE CONTÉM "TOTAL"
        const totalRowIndex = finalRows.findIndex(row => row[0] && String(row[0]).toLowerCase().includes('total'));
        if (totalRowIndex !== -1) finalRows = finalRows.slice(0, totalRowIndex);

        const vinculoIdx = findOriginalIndex('VINCULO'), situacaoIdx = findOriginalIndex('SITUACAO'),
              filialIdx = findOriginalIndex('FILIAL'), cpfIdx = findOriginalIndex('CPF'),
              pisIdx = findOriginalIndex('PIS'), admissaoIdx = findOriginalIndex('ADMISSAO'),
              nascIdx = findOriginalIndex('NASCIMENTO');

        // ETAPA 4: FORMATA AS CÉLULAS DE CADA LINHA RESTANTE
        const formattedData = finalRows.map(row => {
            const newRow = [];
            columnsToKeep.forEach(colIdx => {
                let cell = row[colIdx] ?? '';

                if (colIdx === vinculoIdx) {
                    switch (String(cell)) {
                        case '10': cell = 'EFETIVO/CLT'; break;
                        case '50': cell = 'TEMPORARIO'; break;
                        case '55': cell = 'JOVEM APRENDIZ'; break;
                    }
                }
                if (colIdx === situacaoIdx) {
                    switch (String(cell)) {
                        case '1': case '001': cell = 'Trabalhando'; break;
                        case '2': case '002': cell = 'Férias'; break;
                        case '3': case '003': cell = 'Auxílio Doença'; break;
                        case '4': case '004': cell = 'Acidente de Trabalho'; break;
                        case '5': case '005': cell = 'Serviço Militar'; break;
                        case '6': case '006': cell = 'Licença Maternidade'; break;
                        case '7': case '007': cell = 'Demitido'; break;
                    }
                }
                
                if (colIdx === filialIdx) {
                    const filial = filialMapping.find(f => f.code === String(cell));
                    if (filial) cell = filial.name;
                }

                if (colIdx === cpfIdx) {
                    let cpf = String(cell).replace(/\D/g, '').padStart(11, '0');
                    if (cpf.length === 11) cell = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                }
                if (colIdx === pisIdx) {
                    let pis = String(cell).replace(/\D/g, '').padStart(11, '0');
                    if (pis.length === 11) cell = pis.replace(/(\d{3})(\d{5})(\d{2})(\d{1})/, '$1.$2.$3-$4');
                }
                if (colIdx === admissaoIdx || colIdx === nascIdx) {
                    if (typeof cell === 'number') {
                        cell = excelSerialToBRDate(cell);
                    } else if (typeof cell === 'string') {
                        const s = cell.trim();
                        const m1 = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s);
                        const m2 = /^(\d{4})-(\d{1,2})-(\d{1,2})$/.exec(s);
                        if (m1) {
                            const dd = m1[1].padStart(2, '0'), mm = m1[2].padStart(2, '0'), yy = m1[3];
                            cell = `${dd}/${mm}/${yy}`;
                        } else if (m2) {
                            const dd = m2[3].padStart(2, '0'), mm = m2[2].padStart(2, '0'), yy = m2[1];
                            cell = `${dd}/${mm}/${yy}`;
                        }
                    }
                }
                
                newRow.push(cell);
            });
            return newRow;
        });

        // ETAPA 5: MONTA E BAIXA O NOVO ARQUIVO XLSX
        const finalData = formattedData || [];
        finalData.unshift(newHeaders);
        const newWorkbook = XLSX.utils.book_new();
        const newWorksheet = XLSX.utils.aoa_to_sheet(finalData);
        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Planilha Formatada');
        XLSX.writeFile(newWorkbook, 'planilha_formatada.xlsx');
    }
    
    // Inicializa a lista de busca de operações
    populateOperationsList();
  </script>
</body>
</html>

