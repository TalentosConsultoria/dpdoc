<!DOCTYPE html><html lang="pt-br"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Login - Talentos Consultoria</title>
<script data-cfasync="false" src="https://cdn.tailwindcss.com"></script>
<script data-cfasync="false" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script data-cfasync="false" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script data-cfasync="false" src="./config.js?v=3.5"></script>
<script data-cfasync="false" src="./auth-guard.js?v=3.5"></script>
<style>body{background:#f7f7f7}</style></head>
<body class="min-h-screen flex items-center justify-center">
<div class="bg-white rounded-2xl shadow p-6 w-full max-w-md">
<h1 class="text-2xl font-semibold mb-4">Acesso Talentos Consultoria</h1>
<p class="text-sm text-gray-600 mb-4">Faça login com sua conta corporativa @talentosconsultoria.com.br</p>
<div id="status" class="text-sm text-gray-700 mb-4"></div>
<button id="btnLogin" class="w-full py-2 rounded-xl border hover:shadow">Entrar com Microsoft</button>
</div>
<script>
(function() {
  const params = new URLSearchParams(location.search);
  const rawReturn = params.get("return");
  const error = params.get("error");

  let returnUrl = (window.TalentosAuthGuard
    ? TalentosAuthGuard.safeReturnUrl(rawReturn || TalentosConfig.DEFAULT_RETURN)
    : (rawReturn || "index.html"));
  if (!returnUrl || returnUrl === "/") returnUrl = "index.html";

  const status = document.getElementById("status") || { textContent: "" };
  const auth = firebase.auth();

  if (error === "forbidden") {
    status.textContent = "Conta fora do domínio permitido. Use seu e-mail corporativo.";
  }

  // Se o guard já existir, valida domínio; se não, deixa o index.html validar.
  function shouldRedirect(user) {
    if (!user) return false;
    if (!window.TalentosAuthGuard) return true; // guard ainda não carregou -> deixa o index validar
    try { return TalentosAuthGuard.emailDomainAllowed(user.email); }
    catch { return true; } // qualquer erro -> deixa o index validar
  }

  let redirected = false;

  // 1) Listener imediato
  auth.onAuthStateChanged(function(u) {
    if (redirected) return;
    if (u && shouldRedirect(u)) {
      redirected = true;
      location.replace(returnUrl);
    } else if (u && window.TalentosAuthGuard) {
      // Usuário logado mas domínio barrado -> sai e mostra mensagem
      auth.signOut().finally(() => {
        status.textContent = "Conta fora do domínio permitido. Use seu e-mail corporativo.";
      });
    }
  });

  // 2) Persistência (não bloqueia)
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .catch(e => console.warn("[login] setPersistence", e));

  // 3) Pós-redirect oficial
  (async function handleResult() {
    try {
      const result = await auth.getRedirectResult();
      if (!redirected && result && result.user) {
        if (shouldRedirect(result.user)) {
          redirected = true;
          location.replace(returnUrl);
          return;
        } else {
          await auth.signOut();
          status.textContent = "Conta fora do domínio permitido. Use seu e-mail corporativo.";
        }
      }
    } catch (e) {
      console.error("[login] getRedirectResult", e);
      status.textContent = (e && (e.code || e.message))
        ? (e.code + " – " + e.message)
        : "Erro ao processar retorno do login.";
    }
  })();

  // 4) Fallback: polling 5s
  let tries = 0;
  const iv = setInterval(function() {
    if (redirected) { clearInterval(iv); return; }
    const u = auth.currentUser;
    if (u && shouldRedirect(u)) {
      redirected = true;
      clearInterval(iv);
      location.replace(returnUrl);
    }
    if (++tries >= 10) clearInterval(iv);
  }, 500);

  // 5) Botão de login
  const provider = new firebase.auth.OAuthProvider('microsoft.com');
  provider.setCustomParameters({ prompt: 'select_account', domain_hint: 'talentosconsultoria.com.br' });
  const FLAG = 'talentos_login_inflight';

  async function doLoginRedirect() {
    if (sessionStorage.getItem(FLAG) === '1') return;
    sessionStorage.setItem(FLAG, '1');
    try { await auth.signInWithRedirect(provider); }
    catch (e) {
      console.error("[login] signInWithRedirect", e);
      sessionStorage.removeItem(FLAG);
      status.textContent = (e && (e.code || e.message))
        ? (e.code + " – " + e.message)
        : "Falha ao iniciar login por redirecionamento.";
    }
  }

  document.getElementById("btnLogin")?.addEventListener("click", doLoginRedirect);
})();
</script>
