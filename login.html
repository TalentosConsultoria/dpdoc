<script>
(function() {
    let returnUrl = TalentosAuthGuard.safeReturnUrl(rawReturn) || TalentosConfig.DEFAULT_RETURN;
    if (returnUrl === "/" || returnUrl === "") { returnUrl = "index.html"; }
    const status = document.getElementById("status");
    const warn = document.getElementById("warnConfig");

    try { 
        if (window.__TalentosHasPlaceholderConfig && !_TalentosHasPlaceholderConfig()) 
            warn.classList.remove("hidden");
    } catch(e) {}

    if (error === "forbidden") {
        status.textContent = "Conta fora do domínio permitido. Use seu e-mail corporativo.";
    }

    const auth = firebase.auth();

    // Garante persistência local antes de qualquer operação
    (async () => {
        try {
            await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        } catch(e) {
            console.warn('setPersistence failed', e);
        }
    })();

    const provider = new firebase.auth.OAuthProvider('microsoft.com');
    provider.setCustomParameters({ prompt: 'select_account', domain_hint: 'talentosconsultoria.com.br' });

    const FLAG = 'talentos_login_inflight';

    async function handleResult() {
        try {
            const result = await auth.getRedirectResult();
            if (result && result.user) {
                if (TalentosAuthGuard.emailDomainAllowed(result.user.email)) {
                    window.location.replace(returnUrl);
                    return;
                } else {
                    await auth.signOut();
                    status.textContent = "Conta fora do domínio permitido. Use seu e-mail corporativo.";
                    return;
                }
            }
        } catch(e) {
            console.error(e);
        }
    }

    handleResult();
})();
</script>
