<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Talentos Consultoria</title>

  <!-- Tailwind (layout mínimo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

  <!-- Config do projeto (garante TalentosConfig) -->
  <script src="./config.js?v=20250812"></script>

  <style>
    body { background:#0b1020; color:#e5e7eb; }
    .card{ background:rgba(16,25,50,.92); border:1px solid rgba(255,255,255,.08);
           box-shadow: 0 10px 25px rgba(0,0,0,.35); }
    .btn{ background:#111827; border:1px solid rgba(255,255,255,.08); padding:.65rem 1rem; border-radius:.75rem; }
    .btn:hover{ background:#1f2937; }
    .muted{ color:#9ca3af; font-size:.875rem; }
  </style>

  <script>
    // --- Login URL sanitizer: remove return loops, URLs muito longas e return apontando para login.html ---
    (function () {
      "use strict";
      try {
        const qs = new URLSearchParams(location.search);
        const ret = qs.get("return");
        if (!ret) return;
        const tooLong = location.search.length > 1800 || (ret && ret.length > 1500);
        let hasNested = /[?&]return=/i.test(ret);
        let isLoginTarget = false;
        try {
          const u = new URL(ret, location.href);
          if (/[?&]return=/i.test(u.search)) hasNested = true;
          isLoginTarget = /(^|\/)login(\.html)?$/i.test(u.pathname);
        } catch {
          isLoginTarget = true; // inválida -> trata como insegura
        }
        if (tooLong || hasNested || isLoginTarget) {
          qs.delete("return");
          const clean = location.pathname + (qs.toString() ? ("?" + qs.toString()) : "") + location.hash;
          try { history.replaceState(null, "", clean); } catch { location.replace(clean); }
          console.log("[login] return inválido/recursivo removido");
        }
      } catch (e) { console.warn("[login] sanitizer error", e); }
    })();

    // --- Util: safeReturn (sem depender do guard) ---
    function safeReturn(candidate){
      const fallback = (window.TalentosConfig && (TalentosConfig.DEFAULT_RETURN || "index.html")) || "index.html";
      if (!candidate) return fallback;
      try {
        const u = new URL(candidate, location.href);
        const sameOrigin = u.origin === location.origin;
        const isLogin = /(^|\/)login(\.html)?$/i.test(u.pathname);
        const hasNested = /[?&]return=/i.test(u.search);
        if (!sameOrigin || isLogin || hasNested) return fallback;
        return u.pathname + u.search + u.hash;
      } catch { return fallback; }
    }

    // --- Autenticação ---
    async function doLogin(){
      try {
        const auth = firebase.auth();
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        // Provedor Microsoft (ajuste aqui se usar outro provedor)
        const provider = new firebase.auth.OAuthProvider('microsoft.com');

        try {
          await auth.signInWithPopup(provider);
        } catch (e) {
          console.warn("[login] popup falhou, usando redirect", e);
          await auth.signInWithRedirect(provider);
          return; // fluxo continuará via redirect result
        }
      } catch (e) {
        console.error("[login] erro ao iniciar login", e);
        const s = document.getElementById("status");
        if (s) s.textContent = "Falha ao iniciar login. Tente novamente.";
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const status = document.getElementById("status");
      const auth = firebase.auth();
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

      auth.onAuthStateChanged(async (user) => {
        try{
          if (!user) {
            // Sem sessão: dispara login automático, mantém botão como fallback
            status.textContent = "Redirecionando para o provedor...";
            doLogin();
            return;
          }
          // Filtro de domínio
          const allowed = (window.TalentosConfig?.ALLOWED_DOMAINS || ["talentosconsultoria.com.br"]);
          const domain = String(user.email||"").split("@")[1]||"";
          if (allowed.length && !allowed.map(d=>String(d).toLowerCase()).includes(domain.toLowerCase())) {
            status.textContent = "Domínio não permitido. Realizando logout...";
            try { await auth.signOut(); } catch(e){}
            location.replace("login.html?error=forbidden");
            return;
          }
          // Sessão ok → redireciona para retorno seguro
          const raw = new URLSearchParams(location.search).get("return");
          const ret = safeReturn(raw);
          status.textContent = "Autenticado. Abrindo " + ret + "...";
          location.replace(ret);
        }catch(e){
          console.error(e);
          status.textContent = "Erro inesperado na autenticação.";
        }
      });

      // Botão fallback
      const btn = document.getElementById("btnLogin");
      btn?.addEventListener("click", doLogin);
    });
  </script>
</head>
<body class="min-h-screen grid place-items-center">
  <div class="card rounded-2xl p-6 w-full max-w-md">
    <h1 class="text-xl font-semibold mb-2">Acesso Talentos Consultoria</h1>
    <p id="status" class="muted mb-4">Aguardando autenticação...</p>
    <button id="btnLogin" class="btn w-full">Entrar com Microsoft</button>
    <p class="muted mt-4">O login iniciará automaticamente. Se o navegador bloquear o popup, use o botão acima.</p>
  </div>
</body>
</html>
