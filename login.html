<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login - Talentos Consultoria</title>
  <link rel="icon" href="data:,">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1A237E',
            secondary: '#FF6F00',
            background: '#F0F4F8',
            card: '#FFFFFF',
            text: '#212121',
            'text-muted': '#616161',
          },
          fontFamily: { sans: ['Poppins','sans-serif'] },
          animation: { 
            fadeIn: 'fadeIn 1s ease-in-out',
            pulse: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            bounce: 'bounce 1s infinite'
          },
          keyframes: { 
            fadeIn: {'0%':{opacity:0,transform:'translateY(20px)'},'100%':{opacity:1,transform:'translateY(0)'}}
          },
        }
      }
    }
  </script>

  <!-- MSAL.js v2 via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/msal/2.38.3/msal.min.js"></script>
</head>

<body class="bg-gradient-to-br from-background via-gray-100 to-blue-50 flex min-h-screen font-sans text-text">
  
  <!-- Background Animation -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 bg-blue-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-purple-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse"></div>
  </div>

  <main class="flex-grow flex flex-col justify-center items-center p-4 relative z-10">
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white p-8 rounded-xl shadow-2xl text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
        <p class="text-gray-600">Conectando com Microsoft...</p>
      </div>
    </div>

    <!-- Login Card -->
    <div class="bg-card p-8 md:p-12 rounded-3xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 animate-fadeIn hover:shadow-3xl">
      
      <!-- Logo and Title -->
      <div class="mb-8">
        <img src="https://media.glassdoor.com/sqll/2733569/talentos-consultoria-squarelogo-1649741391944.png" 
             alt="Logo Talentos Consultoria" 
             class="mx-auto h-20 w-20 rounded-full shadow-lg mb-6 hover:scale-110 transition-transform duration-300">
        
        <h1 class="text-3xl md:text-4xl font-bold text-primary mb-2">Bem-vindo!</h1>
        <p class="text-md text-text-muted">Acesse sua conta corporativa</p>
        <div class="w-20 h-1 bg-gradient-to-r from-primary to-secondary rounded-full mx-auto mt-4"></div>
      </div>

      <!-- Login Form -->
      <div class="space-y-6">
        
        <!-- Microsoft Login Button -->
        <button id="btn-login" onclick="handleLogin()"
                class="w-full py-4 px-6 bg-gradient-to-r from-primary to-blue-600 text-white font-semibold rounded-2xl shadow-lg hover:from-secondary hover:to-orange-500 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed group"
                disabled>
          <div class="flex items-center justify-center space-x-3">
            <svg class="w-6 h-6 group-hover:rotate-12 transition-transform duration-300" viewBox="0 0 24 24" fill="currentColor">
              <path d="M5.8 2h5.4c.9 0 1.8.4 1.8 1.3v5.4c0 .9-.9 1.3-1.8 1.3H5.8c-.9 0-1.8-.4-1.8-1.3V3.3C4 2.4 4.9 2 5.8 2z"/>
              <path d="M13.2 2h5.6c.9 0 1.2.4 1.2 1.3v5.4c0 .9-.3 1.3-1.2 1.3h-5.6c-.9 0-1.2-.4-1.2-1.3V3.3c0-.9.3-1.3 1.2-1.3z"/>
              <path d="M5.8 14h5.4c.9 0 1.8.4 1.8 1.3v5.4c0 .9-.9 1.3-1.8 1.3H5.8c-.9 0-1.8-.4-1.8-1.3v-5.4c0-.9.9-1.3 1.8-1.3z"/>
              <path d="M13.2 14h5.6c.9 0 1.2.4 1.2 1.3v5.4c0 .9-.3 1.3-1.2 1.3h-5.6c-.9 0-1.2-.4-1.2-1.3v-5.4c0-.9.3-1.3 1.2-1.3z"/>
            </svg>
            <span class="text-lg">Entrar com Microsoft</span>
          </div>
        </button>

        <!-- Alternative Login Options -->
        <div class="relative">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-300"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-2 bg-card text-text-muted">ou</span>
          </div>
        </div>

        <!-- Demo Login Button -->
        <button onclick="handleDemoLogin()"
                class="w-full py-3 px-6 border-2 border-gray-300 text-gray-600 font-medium rounded-2xl hover:border-primary hover:text-primary transition-all duration-300 transform hover:-translate-y-0.5">
          <div class="flex items-center justify-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <span>Acesso Demo</span>
          </div>
        </button>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="hidden mt-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg animate-bounce">
        <div class="flex items-center space-x-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
          <span id="error-text"></span>
        </div>
      </div>

      <!-- Success Message -->
      <div id="success-message" class="hidden mt-6 p-4 bg-green-50 border border-green-200 text-green-700 rounded-lg">
        <div class="flex items-center space-x-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          <span id="success-text"></span>
        </div>
      </div>

      <!-- Help Text -->
      <div class="mt-8 text-sm text-text-muted space-y-2">
        <p>Use sua conta corporativa <strong>@talentosconsultoria.com.br</strong></p>
        <p class="text-xs">Problemas para acessar? Entre em contato com o suporte.</p>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-sm text-text-muted">
      <p>&copy; 2025 Talentos Consultoria. Todos os direitos reservados.</p>
      <div class="mt-2 space-x-4">
        <a href="#" class="hover:text-primary transition-colors">Política de Privacidade</a>
        <span>•</span>
        <a href="#" class="hover:text-primary transition-colors">Termos de Uso</a>
        <span>•</span>
        <a href="#" class="hover:text-primary transition-colors">Suporte</a>
      </div>
    </div>
  </main>

  <script>
    // ========== CONFIGURAÇÃO MSAL ==========
    const msalConfig = {
      auth: {
        clientId: "aceb5b29-df99-4d90-8533-233407b08a2c",
        authority: "https://login.microsoftonline.com/cba0be9f-94ad-4a26-b291-fa90af7491ee",
        redirectUri: window.location.origin + "/index.html",
        postLogoutRedirectUri: window.location.origin + "/login.html",
        navigateToLoginRequestUrl: false
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: true
      }
    };

    const loginRequest = {
      scopes: ["User.Read", "openid", "profile"],
      prompt: "select_account"
    };

    // Configurações
    const ENFORCE_DOMAIN = true;
    const ALLOWED_DOMAIN = "talentosconsultoria.com.br";

    let msalInstance;

    // ========== FUNÇÕES UTILITÁRIAS ==========
    function showLoading(show = true) {
      const overlay = document.getElementById("loading-overlay");
      if (overlay) {
        overlay.classList.toggle("hidden", !show);
      }
    }

    function showMessage(type, message) {
      const errorDiv = document.getElementById("error-message");
      const successDiv = document.getElementById("success-message");
      const errorText = document.getElementById("error-text");
      const successText = document.getElementById("success-text");

      // Esconder todas as mensagens
      if (errorDiv) errorDiv.classList.add("hidden");
      if (successDiv) successDiv.classList.add("hidden");

      if (type === "error" && errorDiv && errorText) {
        errorText.textContent = message;
        errorDiv.classList.remove("hidden");
      } else if (type === "success" && successDiv && successText) {
        successText.textContent = message;
        successDiv.classList.remove("hidden");
      }
    }

    function validateDomain(username) {
      if (!ENFORCE_DOMAIN) return true;
      
      if (!username || typeof username !== "string") {
        throw new Error("Usuário inválido");
      }
      
      const isValidDomain = username.toLowerCase().endsWith("@" + ALLOWED_DOMAIN);
      if (!isValidDomain) {
        throw new Error(`Apenas usuários do domínio @${ALLOWED_DOMAIN} podem acessar o sistema`);
      }
      
      return true;
    }

    function getRedirectUrl() {
      const savedRedirect = localStorage.getItem("redirectAfterLogin");
      localStorage.removeItem("redirectAfterLogin");
      return savedRedirect || "index.html";
    }

    function enableLoginButton() {
      const btn = document.getElementById("btn-login");
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = `
          <div class="flex items-center justify-center space-x-3">
            <svg class="w-6 h-6 group-hover:rotate-12 transition-transform duration-300" viewBox="0 0 24 24" fill="currentColor">
              <path d="M5.8 2h5.4c.9 0 1.8.4 1.8 1.3v5.4c0 .9-.9 1.3-1.8 1.3H5.8c-.9 0-1.8-.4-1.8-1.3V3.3C4 2.4 4.9 2 5.8 2z"/>
              <path d="M13.2 2h5.6c.9 0 1.2.4 1.2 1.3v5.4c0 .9-.3 1.3-1.2 1.3h-5.6c-.9 0-1.2-.4-1.2-1.3V3.3c0-.9.3-1.3 1.2-1.3z"/>
              <path d="M5.8 14h5.4c.9 0 1.8.4 1.8 1.3v5.4c0 .9-.9 1.3-1.8 1.3H5.8c-.9 0-1.8-.4-1.8-1.3v-5.4c0-.9.9-1.3 1.8-1.3z"/>
              <path d="M13.2 14h5.6c.9 0 1.2.4 1.2 1.3v5.4c0 .9-.3 1.3-1.2 1.3h-5.6c-.9 0-1.2-.4-1.2-1.3v-5.4c0-.9.3-1.3 1.2-1.3z"/>
            </svg>
            <span class="text-lg">Entrar com Microsoft</span>
          </div>
        `;
      }
    }

    // ========== FUNÇÕES DE AUTENTICAÇÃO ==========
    async function handleLogin() {
      if (!msalInstance) {
        showMessage("error", "Sistema de autenticação não inicializado. Recarregue a página.");
        return;
      }

      try {
        showLoading(true);
        showMessage("success", "Redirecionando para Microsoft...");
        
        await msalInstance.loginRedirect(loginRequest);
      } catch (error) {
        console.error("Erro no login:", error);
        showLoading(false);
        showMessage("error", "Erro ao iniciar login. Tente novamente.");
      }
    }

    function handleDemoLogin() {
      showMessage("success", "Redirecionando para versão demo...");
      setTimeout(() => {
        localStorage.setItem("demoUser", "true");
        window.location.href = getRedirectUrl();
      }, 1500);
    }

    async function checkExistingSession() {
      if (!msalInstance) return false;

      try {
        const account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
        
        if (account) {
          console.log("Conta encontrada:", account.username);
          
          validateDomain(account.username);
          
          const tokenResponse = await msalInstance.acquireTokenSilent({
            ...loginRequest,
            account: account
          });

          if (tokenResponse && tokenResponse.accessToken) {
            console.log("Token obtido com sucesso");
            localStorage.setItem("authToken", tokenResponse.accessToken);
            localStorage.setItem("userAccount", JSON.stringify(account));
            
            showMessage("success", "Login realizado com sucesso! Redirecionando...");
            
            setTimeout(() => {
              window.location.href = getRedirectUrl();
            }, 1500);
            
            return true;
          }
        }
        
        return false;
      } catch (error) {
        console.error("Erro ao verificar sessão:", error);
        
        if (error.name === "InteractionRequiredAuthError") {
          console.log("Interação necessária - usuário precisa fazer login");
          return false;
        }
        
        showMessage("error", error.message);
        return false;
      }
    }

    async function handleRedirectResponse() {
      if (!msalInstance) return;

      try {
        showLoading(true);
        
        const response = await msalInstance.handleRedirectPromise();
        
        if (response && response.account) {
          console.log("Resposta do redirect recebida:", response.account.username);
          
          validateDomain(response.account.username);
          
          msalInstance.setActiveAccount(response.account);
          
          if (response.accessToken) {
            localStorage.setItem("authToken", response.accessToken);
            localStorage.setItem("userAccount", JSON.stringify(response.account));
            
            showMessage("success", "Login realizado com sucesso! Redirecionando...");
            
            setTimeout(() => {
              window.location.href = getRedirectUrl();
            }, 1500);
          }
        } else {
          const hasSession = await checkExistingSession();
          if (!hasSession) {
            enableLoginButton();
          }
        }
      } catch (error) {
        console.error("Erro ao processar redirect:", error);
        showMessage("error", error.message);
        enableLoginButton();
      } finally {
        showLoading(false);
      }
    }

    // ========== INICIALIZAÇÃO ==========
    async function initializeAuth() {
      try {
        if (typeof msal === "undefined") {
          throw new Error("Biblioteca MSAL não carregou corretamente");
        }

        msalInstance = new msal.PublicClientApplication(msalConfig);
        await msalInstance.initialize();

        console.log("MSAL inicializado com sucesso");

        await handleRedirectResponse();

      } catch (error) {
        console.error("Erro na inicialização:", error);
        showMessage("error", "Erro ao inicializar sistema de login. Verifique sua conexão e recarregue a página.");
        enableLoginButton();
      }
    }

    // ========== EVENTOS ==========
    window.addEventListener("DOMContentLoaded", initializeAuth);

    window.handleLogin = handleLogin;
    window.handleDemoLogin = handleDemoLogin;

    // Debug
    window.msalDebug = {
      getInstance: () => msalInstance,
      getAccounts: () => msalInstance?.getAllAccounts(),
      clearCache: () => {
        localStorage.clear();
        msalInstance?.clearCache();
      }
    };
  </script>
</body>
</html>