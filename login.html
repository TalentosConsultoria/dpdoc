<script>
(function () {
  // ===== retorno pós-login (mantido) =====
  const params = new URLSearchParams(location.search);
  const rawReturn = params.get("return");
  const defaultReturn = (window.TalentosConfig && TalentosConfig.DEFAULT_RETURN) || "index.html";
  let returnUrl = (window.TalentosAuthGuard ? TalentosAuthGuard.safeReturnUrl(rawReturn || defaultReturn) : (rawReturn || defaultReturn));
  if (!returnUrl || returnUrl === "/") returnUrl = "index.html";

  const statusEl = document.getElementById("status");
  const setStatus = (t) => { if (statusEl) statusEl.textContent = t || ""; };

  // ===== Firebase Auth (compat) =====
  const auth = firebase.auth();
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => {});

  // ===== Provider Microsoft COM TENANT FIXO =====
  const TENANT = (window.TalentosConfig && (TalentosConfig.AAD_TENANT_ID || TalentosConfig.AAD_TENANT))
                 || "cba0be9f-94ad-4a26-b291-fa90af7491ee"; // seu tenant
  const provider = new firebase.auth.OAuthProvider("microsoft.com");
  try {
    provider.setCustomParameters({ tenant: TENANT, prompt: "select_account" });
    // scopes padrão já incluem openid profile email
  } catch (e) {
    console.warn("[login] setCustomParameters", e);
  }

  // ===== helpers =====
  function emailDomainAllowed(email) {
    try {
      if (window.TalentosAuthGuard && TalentosAuthGuard.emailDomainAllowed) {
        return TalentosAuthGuard.emailDomainAllowed(email);
      }
    } catch {}
    const dom = (window.TalentosConfig && TalentosConfig.ALLOWED_EMAIL_DOMAIN) || "talentosconsultoria.com.br";
    return (email || "").toLowerCase().endsWith("@" + dom);
  }
  function shouldPass(user){ return !!(user && emailDomainAllowed(user.email || "")); }

  let navigated = false;

  // 1) Processa retorno do redirect primeiro
  auth.getRedirectResult().then((res) => {
    if (!navigated && res && res.user && shouldPass(res.user)) {
      navigated = true;
      location.replace(returnUrl);
    }
  }).catch((e) => {
    console.error("[login] getRedirectResult:", e);
    const m = (e && e.message) || "";
    // mensagem clara se ainda bater /common
    if (m.includes("AADSTS50194")) setStatus("Falha de tenant (/common). Tente novamente.");
    else setStatus(m || "Falha ao concluir login.");
  });

  // 2) Se já tem sessão, segue
  auth.onAuthStateChanged((u) => {
    if (navigated) return;
    if (u) {
      if (shouldPass(u)) {
        navigated = true;
        location.replace(returnUrl);
      } else {
        auth.signOut().finally(() => setStatus("Conta fora do domínio permitido."));
      }
    }
  });

  // 3) Ação do botão → popup, fallback redirect
  async function doLogin() {
    setStatus("Abrindo Microsoft…");
    try {
      await auth.signInWithPopup(provider);
      // onAuthStateChanged/redirectResult fará o resto
    } catch (e) {
      console.warn("[login] popup bloqueado/erro, fallback redirect:", e && (e.code || e.message));
      try {
        await auth.signInWithRedirect(provider);
      } catch (e2) {
        console.error("[login] redirect falhou:", e2);
        setStatus((e2 && (e2.code + " – " + e2.message)) || "Falha ao iniciar login.");
      }
    }
  }
  document.getElementById("btnLogin")?.addEventListener("click", doLogin);
})();
</script>
